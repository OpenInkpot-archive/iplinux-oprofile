MOC=@MOC@
UIC=@UIC@

CXXFLAGS=-ansi -Wall -pedantic -W @CXXFLAGS@ @QT2_INCLUDES@

.PHONY: all clean install uninstall
.SUFFIXES:

ifeq "@have_qt2@" "yes"
all: oprof_start

clean:
	$(MAKE) -C ui clean
	rm -rf *.o .deps *.moc.* oprof_start

install: all oprof_start
	-$(MKDIR_P) $(BINDIR)
	cp oprof_start $(BINDIR)/oprof_start && chmod 755 $(BINDIR)/oprof_start

uninstall:
	-rm -f $(BINDIR)/oprof_start
	@echo "---------------------------------------------------------------"
	@echo "The uninstall target does not remove your ~/.oprofile directory"
	@echo "---------------------------------------------------------------"

UISOURCES=ui/oprof_start.base.o ui/oprof_start.base.moc.o
SOURCES=oprof_start.o oprof_start.moc.o ../events/op_events.o \
 ../events/op_events_desc.o oprof_start_config.o oprof_start_main.o \
 oprof_start_util.o ../util/string_manip.o ../util/child_reader.o ../util/file_manip.o

oprof_start: $(SOURCES)
	$(MAKE) -C ui
	$(CXX) $(CXXFLAGS) -o $@ $^ $(UISOURCES) @QT2_LDFLAGS@ @QT2_LIBS@ -liberty

# we need explicit dependencies and build rules here else after a make clean
# dependencies can not be regenerated
ui/oprof_start.base.h: ui/oprof_start.base.ui
	$(MAKE) -C ui oprof_start.base.h
ui/oprof_start.base.moc.cpp: ui/oprof_start.base.h
	$(MAKE) -C ui oprof_start.base.h

oprof_start.moc.o: oprof_start.moc.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@
oprof_start.o: oprof_start.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@
oprof_start_config.o: oprof_start_config.cpp
	$(CXX) $(CXXFLAGS) -DKVERSION=\"@KVERS@\" -c $< -o $@
oprof_start_util.o: oprof_start_util.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@
oprof_start_main.o: oprof_start_main.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@

# generate qt moc code for subclass
oprof_start.moc.cpp: oprof_start.h  ui/oprof_start.base.h
	$(MOC) -o oprof_start.moc.cpp oprof_start.h

ALL_SOURCES = oprof_start_util.cpp oprof_start_config.cpp oprof_start_main.cpp oprof_start.cpp oprof_start.moc.cpp

# FIXME kludge
# Makefile depends on included .d file which needs ui/oprof_start.base.h to be
# created so add an explicit rules to create it, I see no way to avoid it.
oprof_start.cpp.d: ui/oprof_start.base.h

include ../Rules.make

CPPFLAGS_DEPS += @QT2_INCLUDES@

else
all:
clean:
install:
uninstall:
endif
