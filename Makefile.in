# $Id$

KCFLAGS=@KCFLAGS@
MODINSTALLDIR=@MODINSTALLDIR@/oprofile
CC=@CC@
LD=@LD@

.PHONY: all install clean distclean tags

all: oprofile.o
	$(MAKE) -C dae
	$(MAKE) -C pp

distclean: clean
	rm -f Makefile dae/Makefile pp/Makefile tags

tags:
	ctags -R

install: oprofile.o
	mkdir -p $(MODINSTALLDIR)
	cp oprofile.o $(MODINSTALLDIR)
	depmod -a
	$(MAKE) -C dae install
	$(MAKE) -C pp install

clean:
	rm -f *.o config.status config.log config.cache
	$(MAKE) -C dae clean
	$(MAKE) -C pp clean

# FIXME: move NMI code into separate to allow -march=ppro for that
KCFLAGS:=-pipe -D__KERNEL__ -DMODULE -Wall -Wstrict-prototypes -Wunused -O2 -march=i586 -fomit-frame-pointer -fno-strict-aliasing $(KCFLAGS)

ASMFLAGS=-D__ASSEMBLY__ -DMODULE -D__KERNEL__ -traditional

oprofile.o: oprofile_c.o oprofile_nmi.o oprofile_k.o op_events.o
	ld -r -o $(G) $@ oprofile_c.o oprofile_nmi.o oprofile_k.o op_events.o

oprofile_c.o: oprofile.c oprofile.h
	$(CC) $(KCFLAGS) $(G) -c -o $@ $<

oprofile_k.o: oprofile_k.c oprofile.h
	$(CC) $(KCFLAGS) $(G) -c -o $@ $<

oprofile.s: oprofile.c oprofile.h
	$(CC) $(KCFLAGS) $(G) -S $<

op_events.o: op_events.c
	$(CC) $(KCFLAGS) $(G) -c -o $@ $<

oprofile_nmi.o: oprofile_nmi.S
	$(CC) $(ASMFLAGS) -c -o $@ $<
