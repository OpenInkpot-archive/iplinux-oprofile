all: oprofpp oprof_convert opf_filter

.PHONY: all clean srcdoc install uninstall

clean: 
	rm -f oprofpp *.o oprofpp-src.html oprof_convert opf_filter

CC=@CC@
prefix=@prefix@
exec_prefix=@exec_prefix@
BINDIR=@bindir@
MANDIR=@mandir@
MKDIR_P=mkdir -p
INSTALL_LIST=oprofpp oprof_convert opf_filter op_to_source

install: all $(INSTALL_LIST)
	-$(MKDIR_P) $(BINDIR)
	for f in $(INSTALL_LIST); do \
		cp $$f $(BINDIR)/$$f && chmod 755 $(BINDIR)/$$f; \
	done

uninstall:
	for f in $(INSTALL_LIST); do \
		rm -f $(BINDIR)/$$f; \
	done

CFLAGS=-Wall -Wstrict-prototypes -W -pipe -DOP_EVENTS_DESC -L/usr/lib @CFLAGS@
LIBS=-lpopt -lbfd -liberty -ldl
INCLUDES=@extra_includes@
HEADERS=oprofpp.h ../dae/opd_util.h ../op_user.h
MY_SOURCES=oprofpp.c
SOURCES=$(MY_SOURCES) ../dae/opd_util.c ../op_events.c

srcdoc: oprofpp-src.html

oprofpp-src.html: $(MY_SOURCES)
	../scripts/dodoc -html $(MY_SOURCES) >oprofpp-src.html

oprofpp: $(SOURCES) $(HEADERS)
	g++ $(CFLAGS) $(INCLUDES) -o $@ $(SOURCES) $(LIBS)

oprof_convert: oprof_convert.c ../dae/opd_util.c ../dae/opd_util.h
	$(CC) -Wall oprof_convert.c ../dae/opd_util.c -o $@

#CXX_DEBUG_LIBS = -L/usr/src/STLport-4.0/lib -lm -lstlport_gcc_stldebug
#CXXFLAGS_DEBUG_STL = -D__STL_DEBUG -I/usr/src/STLport-4.0/stlport -Wno-long-long

OPF_CXXFLAGS=-Wall -O2 -g $(CXXFLAGS_DEBUG_STL)

oprofpp_no_main.o: oprofpp.c $(HEADERS)
	g++ -c -DOPROFPP_NO_MAIN $(CFLAGS) $(INCLUDES) -o $@ oprofpp.c

opf_container.o: opf_container.cpp opf_filter.h ../op_user.h
	g++ -c $(OPF_CXXFLAGS) $< -o $@

opf_filter.o : opf_filter.cpp opf_filter.h ../op_user.h oprofpp.h
	g++ -c $(OPF_CXXFLAGS) $< -o $@

opf_filter: opf_filter.o opf_container.o oprofpp_no_main.o ../op_events.o ../dae/opd_util.o $(LIBS)
	g++ -DOP_EVENTS_DESC $(CXX_DEBUG_LIBS) $^ -o $@
