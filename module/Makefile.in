# $Id$

BKCFLAGS=@BKCFLAGS@ @MODVERSIONS@
MODINSTALLDIR=@MODINSTALLDIR@/oprofile
MKDIR_P=mkdir -p
CC=@CC@
LD=@LD@

BKCFLAGS += -pipe -D__KERNEL__ -DMODULE -Wall -Wstrict-prototypes -Wunused -O2 -fomit-frame-pointer -fno-strict-aliasing
KCFLAGS := $(BKCFLAGS) -march=i686
ASMFLAGS := -D__ASSEMBLY__ -DMODULE -D__KERNEL__ -traditional

.PHONY: all install clean uninstall

all: oprofile.o

install: all
	-$(MKDIR_P) $(MODINSTALLDIR)
	cp oprofile.o $(MODINSTALLDIR)
	depmod -a

uninstall:
	-rm -f $(MODINSTALLDIR)/oprofile.o
	-rmdir --ignore-fail-on-non-empty  $(MODINSTALLDIR)
	depmod -a

clean:
	rm -f *.o

oprofile.o: op_init.o op_util.o oprofile_c.o oprofile_nmi.o op_syscalls.o op_events_module.o op_x86.o
	$(LD) -r -o $@ $^

oprofile.h: ../op_user.h ../version.h

op_init.o: op_init.c oprofile.h
	$(CC) $(BKCFLAGS) -c -o $@ $<

op_util.o: op_util.c
	$(CC) $(KCFLAGS) -c -o $@ $<

oprofile_c.o: oprofile.c oprofile.h
	$(CC) $(KCFLAGS) -c -o $@ $<

op_x86.o: op_x86.c
	$(CC) $(KCFLAGS) -c -o $@ $<

op_syscalls.o: op_syscalls.c oprofile.h
	$(CC) $(KCFLAGS) -c -o $@ $<

oprofile.s: oprofile.c oprofile.h
	$(CC) $(KCFLAGS) -S $<

op_events_module.o: ../events/op_events.c ../op_user.h
	$(CC) $(KCFLAGS) -c -o $@ $<

oprofile_nmi.o: oprofile_nmi.S
	$(CC) $(ASMFLAGS) -c -o $@ $<
